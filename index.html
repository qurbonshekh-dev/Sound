<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ú–æ–π –ë—é–¥–∂–µ—Ç</title>
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <style>
    :root{--fg:#0f172a;--muted:#64748b;--card:rgba(255,255,255,.72);--accent:#6d28d9}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font:16px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,system-ui,sans-serif;color:var(--fg);background:linear-gradient(#f7fafc,#eef2f7)}
    .container{max-width:960px;margin:0 auto;padding:24px}
    .header{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .logo{display:grid;place-items:center;width:40px;height:40px;border-radius:16px;background:var(--card);backdrop-filter:saturate(180%) blur(16px);border:1px solid #ffffffb3;box-shadow:0 1px 2px rgba(0,0,0,.08)}
    .title{margin:0;font-weight:700;font-size:28px}
    .subtitle{margin:2px 0 0;color:var(--muted);font-size:13px}
    .seg{display:inline-flex;gap:4px;background:var(--card);border:1px solid #ffffffb3;padding:6px;border-radius:16px;backdrop-filter:saturate(180%) blur(16px);box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .seg button{border:0;background:transparent;padding:8px 12px;border-radius:12px;font-size:14px}
    .seg button.active{background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .btn{padding:10px 14px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn.primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .card{background:var(--card);border:1px solid #ffffffb3;border-radius:24px;padding:20px;backdrop-filter:saturate(180%) blur(16px);box-shadow:0 6px 24px rgba(15,23,42,.06)}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    input,select{width:100%;padding:12px 14px;border-radius:14px;border:1px solid #e5e7eb;background:#ffffffb8}
    .grid{display:grid;gap:12px}
    @media(min-width:640px){.grid-2{grid-template-columns:repeat(2,1fr)}}
    .pill{display:flex;align-items:center;gap:8px;justify-content:flex-start;width:100%;padding:12px 14px;border-radius:16px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .pill.active{background:#111827;color:#fff;border-color:#111827}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px 12px;border-top:1px solid #eef2f7;font-size:14px}
    .muted{color:var(--muted)}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">üí∞</div>
      <div>
        <h1 class="title">–ú–æ–π –ë—é–¥–∂–µ—Ç</h1>
        <p class="subtitle">–£—á—ë—Ç –ª–∏—á–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ ‚Äî –æ—Ñ–ª–∞–π–Ω, –ª–æ–∫–∞–ª—å–Ω–æ, –∫–∞–∫ PWA</p>
      </div>
    </header>

    <div class="seg" id="seg">
      <button data-tab="add" class="active">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button data-tab="list">–°–ø–∏—Å–æ–∫</button>
      <button data-tab="report">–û—Ç—á—ë—Ç</button>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnExportCSV">–°–∫–∞—á–∞—Ç—å CSV</button>
      <button class="btn" id="btnExportJSON">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <label class="btn" style="cursor:pointer">
        –ò–º–ø–æ—Ä—Ç JSON
        <input id="fileImport" type="file" accept="application/json" style="display:none" />
      </label>
    </div>
    <!-- ADD -->
    <section class="card" id="tab-add" style="margin-top:16px">
      <h3 style="margin:0 0 12px 0">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h3>
      <div class="grid grid-2">
        <div>
          <label>–°—É–º–º–∞ (–≤–∞–ª—é—Ç–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ)</label>
          <input id="amount" type="text" inputmode="decimal" placeholder="0.00" />
        </div>
        <div>
          <label>–î–∞—Ç–∞</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <div class="grid grid-2" id="categoryGrid"></div>
        <input id="customCat" type="text" placeholder="–°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–¥–ª—è '–î—Ä—É–≥–æ–µ')" style="margin-top:8px;display:none" />
      </div>

      <div style="margin-top:12px">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="note" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–±–µ–¥ –≤ –∫–∞—Ñ–µ" />
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnAdd">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
        <button class="btn" id="btnClearAll" style="color:#dc2626;border-color:#fee2e2">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      </div>
    </section>

    <!-- LIST -->
    <section class="card" id="tab-list" style="margin-top:16px;display:none">
      <div class="row" style="margin-bottom:12px">
        <h3 style="margin:0">–°–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
        <div class="row" style="gap:8px">
          <select id="fltYear"><option value="">–í—Å–µ –≥–æ–¥—ã</option></select>
          <select id="fltMonth"><option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option></select>
          <select id="fltCat"><option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option></select>
          <button class="btn" id="btnReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>
      <div style="overflow:auto;border:1px solid #eef2f7;border-radius:14px">
        <table class="table" id="tbl"></table>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="muted">–ò—Ç–æ–≥–æ –ø–æ –≤—ã–±–æ—Ä–∫–µ: <b id="sum"></b></div>
        <button class="btn" id="btnDownloadFiltered">–°–∫–∞—á–∞—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ CSV</button>
      </div>
    </section>

    <!-- REPORT -->
    <section class="card" id="tab-report" style="margin-top:16px;display:none">
      <h3 style="margin:0 0 12px 0">–û—Ç—á—ë—Ç</h3>
      <div class="grid grid-2">
        <div class="card" style="padding:12px"><div class="muted">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div><div style="font-size:22px;font-weight:700" id="statCount">0</div></div>
        <div class="card" style="padding:12px"><div class="muted">–°—É–º–º–∞ –ø–æ –≤—ã–±–æ—Ä–∫–µ</div><div style="font-size:22px;font-weight:700" id="statSum">0</div></div>
      </div>
      <p class="muted" style="margin-top:12px">–ì—Ä–∞—Ñ–∏–∫–∏ –¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ; —Å–µ–π—á–∞—Å ‚Äî –æ—Ñ–ª–∞–π–Ω‚Äë—è–¥—Ä–æ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫.</p>
    </section>
  </div>

  <script>
  // ==== PWA SW
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>console.warn('SW register failed'));
  }

  // ==== IndexedDB tiny wrapper
  const DB_NAME = 'budget-db';
  const STORE = 'kv';
  const KEY = 'state';

  function idbOpen() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbGet() {
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, 'readonly');
      const st = tx.objectStore(STORE);
      const r = st.get(KEY);
      r.onsuccess = () => resolve(r.result);
      r.onerror = () => reject(r.error);
    });
  }
  async function idbSet(val) {
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, 'readwrite');
      const st = tx.objectStore(STORE);
      const r = st.put(val, KEY);
      r.onsuccess = () => resolve();
      r.onerror = () => reject(r.error);
    });
  }
    // ==== App state
  const DEFAULT_CATEGORIES = ['–ï–¥–∞','–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è','–ó–¥–æ—Ä–æ–≤—å–µ','–ü–æ–∫—É–ø–∫–∏','–°–≤—è–∑—å','–ü–æ–¥–ø–∏—Å–∫–∏','–î–æ–º','–û–¥–µ–∂–¥–∞','–î—Ä—É–≥–æ–µ'];
  let state = { currency: '—Å–æ–º–æ–Ω–∏', expenses: [] };

  function parseAmount(v){ if(typeof v==='number') return v; if(!v) return 0; const n = Number(String(v).replace(',', '.')); return isNaN(n)?0:n; }
  function formatNumber(n){ const num = Number(n||0); return num.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + ' ' + state.currency; }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

  const $ = (sel)=>document.querySelector(sel);
  const $$= (sel)=>Array.from(document.querySelectorAll(sel));

  function setToday(){ $('#date').value = new Date().toISOString().slice(0,10); }

  function renderCategories(){
    const grid = $('#categoryGrid'); grid.innerHTML = '';
    const cats = Array.from(new Set([ ...DEFAULT_CATEGORIES, ...state.expenses.map(e=>e.category).filter(Boolean) ])).sort();
    cats.forEach(c=>{
      const btn = document.createElement('button');
      btn.className = 'pill'; btn.textContent = c; btn.dataset.cat = c;
      btn.onclick = ()=>{ $$('.pill').forEach(p=>p.classList.remove('active')); btn.classList.add('active'); $('#customCat').style.display = (c==='–î—Ä—É–≥–æ–µ')?'block':'none'; };
      grid.appendChild(btn);
    });
  }
  function getSelectedCategory(){
    const active = $('#categoryGrid .pill.active');
    if(!active) return '';
    const c = active.dataset.cat;
    if(c==='–î—Ä—É–≥–æ–µ') return ($('#customCat').value||'').trim();
    return c;
  }

  function toCSV(rows){
    if(!rows?.length) return '';
    const header = ['id','date','amount','category','note'];
    const esc = (s)=> '"'+String(s??'').replace(/"/g,'""')+'"';
    const out = [ header.map(esc).join(',') ];
    for(const r of rows){ out.push([r.id,r.date,r.amount,r.category,r.note].map(esc).join(',')); }
    return out.join('\n');
  }

  function rebuildFilters(){
    const years = new Set(state.expenses.map(e=> (e.date||'').slice(0,4)).filter(Boolean));
    const months=[['01','–Ø–Ω–≤–∞—Ä—å'],['02','–§–µ–≤—Ä–∞–ª—å'],['03','–ú–∞—Ä—Ç'],['04','–ê–ø—Ä–µ–ª—å'],['05','–ú–∞–π'],['06','–ò—é–Ω—å'],['07','–ò—é–ª—å'],['08','–ê–≤–≥—É—Å—Ç'],['09','–°–µ–Ω—Ç—è–±—Ä—å'],['10','–û–∫—Ç—è–±—Ä—å'],['11','–ù–æ—è–±—Ä—å'],['12','–î–µ–∫–∞–±—Ä—å']];
    const cats = new Set(state.expenses.map(e=>e.category).filter(Boolean));
    const sel = (el, items, withLabels=false)=>{ el.innerHTML='<option value="">–í—Å–µ</option>'+items.map(x=>`<option value="${withLabels?x[0]:x}">${withLabels?x[1]:x}</option>`).join('') };
    sel($('#fltYear'), Array.from(years).sort());
    sel($('#fltMonth'), months, true);
    sel($('#fltCat'), Array.from(cats).sort());
  }

  function filterRows(list){
    const fy = $('#fltYear').value; const fm = $('#fltMonth').value; const fc = $('#fltCat').value;
    return list.filter(e=>{
      const y=(e.date||'').slice(0,4); const m=(e.date||'').slice(5,7);
      if(fy && y!==fy) return false; if(fm && m!==fm) return false; if(fc && e.category!==fc) return false; return true;
    });
  }
    function renderTable(){
    const rows = filterRows(state.expenses);
    const tbl = $('#tbl');
    tbl.innerHTML = '<thead><tr><th>–î–∞—Ç–∞</th><th style="text-align:right">–°—É–º–º–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th></th></tr></thead>';
    const body = document.createElement('tbody');
    if(rows.length===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=5; td.className='muted'; td.style.textAlign='center'; td.style.padding='18px'; td.textContent='–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π'; tr.appendChild(td); body.appendChild(tr); }
    rows.forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML = <td>${e.date}</td><td style="text-align:right">${formatNumber(e.amount)}</td><td>${e.category||'‚Äî'}</td><td>${e.note||''}</td><td style="text-align:right"><button class="btn" data-del="${e.id}">–£–¥–∞–ª–∏—Ç—å</button></td>;
      body.appendChild(tr);
    });
    tbl.appendChild(body);
    const sum = rows.reduce((a,e)=>a+parseAmount(e.amount),0); $('#sum').textContent = formatNumber(sum); $('#statSum').textContent = formatNumber(sum); $('#statCount').textContent = String(rows.length);
    body.querySelectorAll('button[data-del]').forEach(b=> b.onclick = ()=>{ const id=b.getAttribute('data-del'); state.expenses = state.expenses.filter(x=>x.id!==id); idbSet(state).then(()=>renderAll()); });
  }

  function renderAll(){ renderCategories(); rebuildFilters(); renderTable(); }

  // Events
  $('#seg').addEventListener('click', (e)=>{ if(e.target.tagName!=='BUTTON') return; const tab=e.target.dataset.tab; $$('#seg button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab)); ['add','list','report'].forEach(k=>$('#tab-'+k).style.display = (k===tab)?'block':'none'); });

  $('#btnAdd').onclick = ()=>{
    const item = {
      id: uid(),
      date: $('#date').value,
      amount: parseAmount($('#amount').value),
      category: getSelectedCategory(),
      note: ($('#note').value||'').trim(),
    };
    if(!item.date || !item.amount){ alert('–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ —Å—É–º–º—É'); return; }
    state.expenses.unshift(item);
    idbSet(state).then(()=>{ $('#amount').value=''; $('#note').value=''; renderAll(); });
  };
  $('#btnClearAll').onclick = ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ä–∞—Å—Ö–æ–¥—ã?')){ state.expenses=[]; idbSet(state).then(renderAll); }};
  $('#btnReset').onclick = ()=>{ $('#fltYear').value=''; $('#fltMonth').value=''; $('#fltCat').value=''; renderAll(); };
  $('#btnDownloadFiltered').onclick = ()=>{ const csv=toCSV(filterRows(state.expenses)); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='expenses-filtered.csv'; a.click(); };
  $('#btnExportCSV').onclick = ()=>{ const csv=toCSV(state.expenses); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='expenses.csv'; a.click(); };
  $('#btnExportJSON').onclick = ()=>{ const json=JSON.stringify(state,null,2); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([json],{type:'application/json'})); a.download='expenses-backup.json'; a.click(); };
  $('#fileImport').addEventListener('change', (ev)=>{ const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(Array.isArray(obj.expenses)) state.expenses=obj.expenses; if(obj.currency) state.currency=obj.currency; idbSet(state).then(()=>{ renderAll(); alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω'); }); }catch{ alert('–ù–µ–≤–µ—Ä–Ω—ã–π JSON'); } }; r.readAsText(f); ev.target.value=''; });

  // Boot
  (async ()=>{
    try{
      const loaded = await idbGet();
      if(loaded){ state = loaded; }
      else{ $('#date').value = new Date().toISOString().slice(0,10); }
    }catch(e){ console.warn('IDB load fail', e); }
    if(!$('#date').value) $('#date').value = new Date().toISOString().slice(0,10);
    renderAll();
  })();
  </script>
</body>
</html>
